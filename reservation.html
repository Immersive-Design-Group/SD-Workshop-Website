---
layout: default
title: Reservation
permalink: /reservation.html/
---

<link rel="stylesheet" href="{{ '/assets/css/reservation.css' | relative_url }}">

<section class="resv-wrap">
  <div class="resv-head">
    <h1 class="ghost">Our</h1>
    <h2 class="title">Reservation</h2>
  </div>

  <div class="rules">
    <h3>预约规则</h3>
    <ul>
      <li>请在下方选择设备和连续空闲时段预约，单次不可超过 5 小时（工作坊开放时间：周一至周五 09:00-22:00）。</li>
      <li>超22点后机器不停机，可夜间打印；次日早晨取件。</li>
      <li>首次使用须完成安全培训，使用前请认真阅读操作手册；</li>
      <li>节假日使用请先发邮件至管理员（designworkshop@sustech.edu.cn）</li>
    </ul>
    <ul class="en">
      <li>Please select a free slot (30-min units), up to 5 hours. Opening hours: Mon–Fri 09:00–22:00.</li>
      <li>After 22:00, machines run on; pick up next morning.</li>
      <li>Training required before first use; read operation manual.</li>
      <li>For holidays, please email the workshop administrator.</li>
    </ul>
  </div>

  <div class="toolbar">
    <button id="prevDay">◀</button>
    <input type="date" id="resvDate">
    <button id="nextDay">▶</button>
    <span class="hint">Times shown in your local time</span>
  </div>

  <div id="grid" class="grid"></div>
</section>

<!-- Book modal -->
<div class="modal" id="bookModal" hidden>
  <div class="dialog">
    <h3>Book <span id="bm-eq"></span></h3>
    <p class="slotline"><span id="bm-date"></span> · <span id="bm-time"></span></p>
    <form id="bookForm">
      <label>Name <input name="name" required></label>
      <label>Email <input type="email" name="email" required></label>
      <label>Purpose <input name="purpose" required></label>
      <label class="chk"><input type="checkbox" name="trained" required> I have accepted the training instruction</label>
      <div class="actions">
        <button type="button" data-close>Cancel</button>
        <button type="submit" class="primary">Submit</button>
      </div>
    </form>
  </div>
</div>

<!-- Cancel modal -->
<div class="modal" id="cancelModal" hidden>
  <div class="dialog">
    <h3>Delete booking</h3>
    <form id="cancelForm">
      <label>Booking ID <input name="id" required></label>
      <label>Email <input type="email" name="email" required></label>
      <div class="row">
        <button type="button" id="sendOtp">Send code</button>
        <input name="otp" placeholder="Enter code">
      </div>
      <div class="actions">
        <button type="button" data-close>Close</button>
        <button type="submit" class="danger">Confirm delete</button>
      </div>
    </form>
  </div>
</div>

<script>
const APPS_SCRIPT_URL = '<<PASTE_YOUR_DEPLOYED_WEB_APP_URL_HERE>>';

// Example equipment list (id, name, image). Replace with your real list.
const EQUIPMENTS = [
  { id: 'x1e-1', name: '3D PRINTER 1 X1E', image: '{{ "/assets/images/equip/x1e.png" | relative_url }}' },
  { id: 'x1e-2', name: '3D PRINTER 2 X1E', image: '{{ "/assets/images/equip/x1e.png" | relative_url }}' },
  { id: 'x1e-3', name: '3D PRINTER 3 X1E', image: '{{ "/assets/images/equip/x1e.png" | relative_url }}' },
  { id: 'x1e-4', name: '3D PRINTER 4 X1E', image: '{{ "/assets/images/equip/x1e.png" | relative_url }}' },
  { id: 'laser-400', name: 'Laser Cutting Machine Speed 400', image: '{{ "/assets/images/equip/speedy.png" | relative_url }}' },
];

const SLOT_MIN = 30;                 // 30-minute slots
const DAY_START = 9 * 60;            // 09:00
const DAY_END   = 22 * 60;           // 22:00
const GRID      = document.getElementById('grid');
const DATE_I    = document.getElementById('resvDate');

const TODAY = new Date();
DATE_I.valueAsDate = TODAY;

document.getElementById('prevDay').onclick = () => shiftDate(-1);
document.getElementById('nextDay').onclick = () => shiftDate(1);
DATE_I.onchange = render;

function shiftDate(d){
  const dt = DATE_I.valueAsDate || new Date();
  dt.setDate(dt.getDate()+d);
  DATE_I.valueAsDate = dt;
  render();
}

let bookings = []; // fetched for selected day

async function fetchBookings(dateStr){
  const url = `${APPS_SCRIPT_URL}?action=list&date=${encodeURIComponent(dateStr)}`;
  const res = await fetch(url);
  const json = await res.json();
  bookings = json.bookings || [];
}

function timeLabel(min) {
  const h = Math.floor(min/60).toString().padStart(2,'0');
  const m = (min%60).toString().padStart(2,'0');
  return `${h}:${m}`;
}

function renderTimeline(containerWidth){
  const now = new Date();
  const sel = DATE_I.value;
  const isToday = sel === now.toISOString().slice(0,10);
  const line = GRID.querySelector('.nowline') || document.createElement('div');
  line.className = 'nowline';
  if (!isToday) { line.style.display = 'none'; return; }

  const minNow = now.getHours()*60 + now.getMinutes();
  const clamped = Math.max(DAY_START, Math.min(DAY_END, minNow));
  const frac = (clamped - DAY_START) / (DAY_END - DAY_START);
  line.style.left = `calc(var(--left) + ${frac*containerWidth}px)`;
  line.style.display = 'block';
}

function renderGrid(){
  GRID.innerHTML = '';

  // header row
  const header = document.createElement('div');
  header.className = 'row header';

  const left = document.createElement('div');
  left.className = 'left';
  left.innerHTML = `<div class="date">${new Date(DATE_I.value).toLocaleDateString()}</div>`;
  header.appendChild(left);

  const right = document.createElement('div');
  right.className = 'right';
  for (let t=DAY_START; t<=DAY_END; t+=60){
    const lab = document.createElement('div');
    lab.className = 'tick';
    lab.textContent = timeLabel(t);
    right.appendChild(lab);
  }
  header.appendChild(right);
  GRID.appendChild(header);

  const width = right.getBoundingClientRect().width;

  // equipment rows
  EQUIPMENTS.forEach(eq => {
    const row = document.createElement('div');
    row.className = 'row';

    const left = document.createElement('div');
    left.className = 'left equip';
    left.innerHTML = `<img src="${eq.image}" alt=""><div class="n">${eq.name}</div>`;
    row.appendChild(left);

    const right = document.createElement('div');
    right.className = 'right slots';
    right.style.setProperty('--slots', (DAY_END - DAY_START)/SLOT_MIN);

    // draw 30-min slots
    for (let t=DAY_START; t<DAY_END; t+=SLOT_MIN){
      const s = document.createElement('button');
      s.className = 'slot';
      s.dataset.start = timeLabel(t);
      s.dataset.end   = timeLabel(t + SLOT_MIN);
      s.onclick = () => openBook(eq, DATE_I.value, s.dataset.start, s.dataset.end);
      right.appendChild(s);
    }

    // paint existing bookings
    bookings
      .filter(b => b.equipment_id === eq.id)
      .forEach(b => {
        const sMin = minutes(b.start_time) - DAY_START;
        const eMin = minutes(b.end_time)   - DAY_START;
        const fracS = sMin / (DAY_END - DAY_START);
        const fracW = (eMin - sMin) / (DAY_END - DAY_START);
        const block = document.createElement('div');
        block.className = 'booking';
        block.style.left = `calc(var(--left) + ${fracS*width}px)`;
        block.style.width = `${fracW*width}px`;
        block.innerHTML = `
          <div class="who">${b.name}</div>
          <div class="time">${b.start_time}–${b.end_time}</div>
          <div class="actions"><button class="cancel" data-id="${b.id}" data-email="${b.email}">Delete</button></div>
        `;
        block.querySelector('.cancel').onclick = (e)=> openCancel(e.target.dataset.id, e.target.dataset.email);
        row.appendChild(block);
      });

    GRID.appendChild(row);
  });

  renderTimeline(width);
}

async function render(){
  await fetchBookings(DATE_I.value);
  renderGrid();
}
// rerender “now” line every minute
setInterval(()=> {
  const headerRight = GRID.querySelector('.row.header .right');
  if (!headerRight) return;
  renderTimeline(headerRight.getBoundingClientRect().width);
}, 60000);
render();

// ====== BOOK MODAL ======
const bookModal = document.getElementById('bookModal');
const bookForm  = document.getElementById('bookForm');
let BOOK_CTX = null;

function openBook(eq, date, start, end){
  BOOK_CTX = { eq, date, start, end };
  document.getElementById('bm-eq').textContent = eq.name;
  document.getElementById('bm-date').textContent = date;
  document.getElementById('bm-time').textContent = `${start} – ${end}`;
  bookModal.hidden = false;
}

document.querySelectorAll('.modal [data-close]').forEach(btn=>{
  btn.onclick = (e)=> e.currentTarget.closest('.modal').hidden = true;
});

bookForm.onsubmit = async (e)=>{
  e.preventDefault();
  const fd = new FormData(bookForm);
  if (!fd.get('trained')) { alert('Please confirm training.'); return; }

  const payload = {
    action: 'book',
    equipment_id: BOOK_CTX.eq.id,
    equipment_name: BOOK_CTX.eq.name,
    date: BOOK_CTX.date,
    start_time: BOOK_CTX.start,
    end_time: BOOK_CTX.end,
    name: fd.get('name'),
    email: fd.get('email'),
    purpose: fd.get('purpose')
  };

  const res = await fetch(APPS_SCRIPT_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const j = await res.json();
  if (!j.ok) return alert(j.error || 'Failed');
  bookModal.hidden = true;
  await render();
  alert('Booking confirmed! A confirmation email has been sent.');
};

// ====== CANCEL MODAL ======
const cancelModal = document.getElementById('cancelModal');
const cancelForm  = document.getElementById('cancelForm');
const sendOtpBtn  = document.getElementById('sendOtp');

function openCancel(id, email){
  cancelModal.hidden = false;
  cancelForm.elements.id.value = id;
  cancelForm.elements.email.value = email;
}

sendOtpBtn.onclick = async ()=>{
  const id    = cancelForm.elements.id.value.trim();
  const email = cancelForm.elements.email.value.trim();
  const res = await fetch(APPS_SCRIPT_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ action:'request-cancel', id, email })
  });
  const j = await res.json();
  if (!j.ok) return alert(j.error || 'Failed to send code');
  alert('Code sent to your email.');
};

cancelForm.onsubmit = async (e)=>{
  e.preventDefault();
  const id    = cancelForm.elements.id.value.trim();
  const email = cancelForm.elements.email.value.trim();
  const otp   = cancelForm.elements.otp.value.trim();

  const res = await fetch(APPS_SCRIPT_URL, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ action:'confirm-cancel', id, email, otp })
  });
  const j = await res.json();
  if (!j.ok) return alert(j.error || 'Failed to cancel');
  cancelModal.hidden = true;
  await render();
  alert('Booking deleted.');
};
</script>
